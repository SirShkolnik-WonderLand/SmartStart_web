<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AliceSolutions Group - Cybersecurity Excellence</title>
    <meta name="description" content="Leading cybersecurity solutions for businesses. ISO compliance, risk assessment, and security consulting services." />
    
    <!-- Preload critical resources with proper crossorigin -->
    <link rel="preload" href="/assets/index-{{HASH}}.js" as="script" crossorigin="anonymous" />
    
    <!-- Load CSS immediately (not just preload) to ensure styles load on refresh -->
    <!-- Vite extracts CSS into separate files in production -->
    <!-- Use conditional loading: only add link if CSS file exists -->
    <script nonce="{{NONCE}}">
      // Dynamically load CSS to handle cases where hash might not match
      // This ensures CSS loads even if the hash in template doesn't match
      (function() {
        const cssHash = '{{CSSHASH}}';
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = '/assets/index-' + cssHash + '.css';
        link.crossOrigin = 'anonymous';
        link.onerror = function() {
          // If CSS file doesn't exist, CSS will be loaded via JS import
          console.log('CSS file not found, will load via JS');
        };
        document.head.appendChild(link);
      })();
    </script>
    
    <!-- Analytics Hub Script with nonce -->
    <script nonce="{{NONCE}}">
      (function(){
        const API_URL = 'https://analytics-hub-server.onrender.com';
        let sessionId = sessionStorage.getItem('ah_session') || Math.random().toString(36).substring(7);
        sessionStorage.setItem('ah_session', sessionId);
        
        function track(type, data) {
          fetch(API_URL + '/api/v1/' + type, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({...data, sessionId}),
            keepalive: true
          }).catch(e => console.log('Analytics:', e));
        }
        
        window.analyticsHub = {
          trackEvent: (name, props) => track('event', {event: {eventType: 'custom', eventName: name, pageUrl: location.href, properties: props, sessionId}}),
          trackConversion: (name, val) => track('conversion', {goalName: name, goalValue: val, pageUrl: location.href}),
          trackPageView: () => track('pageview', {pageUrl: location.href, pageTitle: document.title})
        };
        
        // Check consent from cookie (set by CookieConsentBanner)
        function hasAnalyticsConsent() {
          try {
            const cookie = document.cookie.split(';').find(c => c.trim().startsWith('asg_consent_preferences='));
            if (!cookie) return false; // No consent given yet
            const value = cookie.split('=')[1];
            const parsed = JSON.parse(decodeURIComponent(value));
            return parsed.analytics === true;
          } catch {
            return false;
          }
        }
        
        // Track pageview if consent given, otherwise wait for consent
        if (hasAnalyticsConsent()) {
          track('pageview', {pageUrl: location.href, pageTitle: document.title});
        } else {
          // Wait for consent - will be tracked when consent is given
          // Use longer interval and requestIdleCallback for better performance
          let checkCount = 0;
          const maxChecks = 20; // 20 checks * 1000ms = 20 seconds max
          
          const checkConsent = () => {
            if (checkCount >= maxChecks) return;
            checkCount++;
            
            if (hasAnalyticsConsent()) {
              track('pageview', {pageUrl: location.href, pageTitle: document.title});
              return;
            }
            
            // Use requestIdleCallback if available, otherwise setTimeout with longer delay
            if (window.requestIdleCallback) {
              window.requestIdleCallback(() => {
                setTimeout(checkConsent, 1000);
              }, { timeout: 2000 });
            } else {
              setTimeout(checkConsent, 1000);
            }
          };
          
          // Start checking after a short delay
          setTimeout(checkConsent, 1000);
        }
        
        // Set config for App.tsx compatibility
        if (!window.analyticsHubConfig) {
          window.analyticsHubConfig = { autoTrack: hasAnalyticsConsent() };
        }
      })();
    </script>
  </head>

  <body>
    <div id="root"></div>

    <!-- Main application script with nonce -->
    <script type="module" src="/assets/index-{{HASH}}.js" nonce="{{NONCE}}"></script>
  </body>
</html>
