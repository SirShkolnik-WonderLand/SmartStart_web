<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AliceSolutions Group - Cybersecurity Excellence</title>
    <meta name="description" content="Leading cybersecurity solutions for businesses. ISO compliance, risk assessment, and security consulting services." />
    
    <!-- Preload critical resources with proper crossorigin -->
    <link rel="preload" href="/assets/index-{{HASH}}.js" as="script" crossorigin="anonymous" />
    
    <!-- Load CSS - try separate file first, fallback to JS bundle -->
    <script nonce="{{NONCE}}">
      (function() {
        const cssHash = '{{CSSHASH}}';
        
        // Try to load CSS file if hash is valid
        if (cssHash && cssHash !== 'null' && cssHash !== 'BUSY1Sdf' && cssHash.trim() !== '') {
          const link = document.createElement('link');
          link.rel = 'stylesheet';
          link.href = '/assets/index-' + cssHash + '.css';
          link.crossOrigin = 'anonymous';
          
          link.onerror = function() {
            console.log('CSS file not found - CSS will load via JS bundle');
            if (link.parentNode) {
              link.parentNode.removeChild(link);
            }
            // CSS will load when JS bundle executes (App.tsx imports global.css)
          };
          
          link.onload = function() {
            console.log('CSS loaded successfully from separate file');
          };
          
          document.head.appendChild(link);
        } else {
          // CSS is in JS bundle - ensure it loads by waiting for JS
          // The JS bundle will inject CSS when it loads (App.tsx imports global.css)
          console.log('CSS will load via JS bundle');
          
          // Fallback: Try to find CSS file by checking common patterns
          // This helps if the hash detection failed but CSS file exists
          const tryFindCSS = () => {
            // Try common hash patterns or check if any CSS file exists
            const testHashes = ['DKv5x7X6', 'BUSY1Sdf']; // Add known hashes here
            let attemptIndex = 0;
            
            const tryNext = () => {
              if (attemptIndex >= testHashes.length) return;
              
              const testHash = testHashes[attemptIndex++];
              const link = document.createElement('link');
              link.rel = 'stylesheet';
              link.href = '/assets/index-' + testHash + '.css';
              link.crossOrigin = 'anonymous';
              
              link.onerror = () => {
                if (link.parentNode) link.parentNode.removeChild(link);
                tryNext();
              };
              
              link.onload = () => {
                console.log('CSS found and loaded with fallback hash:', testHash);
              };
              
              document.head.appendChild(link);
            };
            
            tryNext();
          };
          
          // Only try fallback if JS hasn't loaded after a delay
          setTimeout(() => {
            if (!document.querySelector('style[data-vite-dev-id]') && 
                !document.querySelector('link[rel="stylesheet"][href*="index-"]')) {
              tryFindCSS();
            }
          }, 2000);
        }
      })();
    </script>
    
    <!-- Analytics Hub Script with nonce -->
    <script nonce="{{NONCE}}">
      (function(){
        const API_URL = 'https://analytics-hub-server.onrender.com';
        let sessionId = sessionStorage.getItem('ah_session') || Math.random().toString(36).substring(7);
        sessionStorage.setItem('ah_session', sessionId);
        
        function track(type, data) {
          fetch(API_URL + '/api/v1/' + type, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({...data, sessionId}),
            keepalive: true
          }).catch(e => console.log('Analytics:', e));
        }
        
        window.analyticsHub = {
          trackEvent: (name, props) => track('event', {event: {eventType: 'custom', eventName: name, pageUrl: location.href, properties: props, sessionId}}),
          trackConversion: (name, val) => track('conversion', {goalName: name, goalValue: val, pageUrl: location.href}),
          trackPageView: () => track('pageview', {pageUrl: location.href, pageTitle: document.title})
        };
        
        // Check consent from cookie (set by CookieConsentBanner)
        function hasAnalyticsConsent() {
          try {
            const cookie = document.cookie.split(';').find(c => c.trim().startsWith('asg_consent_preferences='));
            if (!cookie) return false; // No consent given yet
            const value = cookie.split('=')[1];
            const parsed = JSON.parse(decodeURIComponent(value));
            return parsed.analytics === true;
          } catch {
            return false;
          }
        }
        
        // Track pageview if consent given, otherwise wait for consent
        if (hasAnalyticsConsent()) {
          track('pageview', {pageUrl: location.href, pageTitle: document.title});
        } else {
          // Wait for consent - will be tracked when consent is given
          // Use longer interval and requestIdleCallback for better performance
          let checkCount = 0;
          const maxChecks = 20; // 20 checks * 1000ms = 20 seconds max
          
          const checkConsent = () => {
            if (checkCount >= maxChecks) return;
            checkCount++;
            
            if (hasAnalyticsConsent()) {
              track('pageview', {pageUrl: location.href, pageTitle: document.title});
              return;
            }
            
            // Use requestIdleCallback if available, otherwise setTimeout with longer delay
            if (window.requestIdleCallback) {
              window.requestIdleCallback(() => {
                setTimeout(checkConsent, 1000);
              }, { timeout: 2000 });
            } else {
              setTimeout(checkConsent, 1000);
            }
          };
          
          // Start checking after a short delay
          setTimeout(checkConsent, 1000);
        }
        
        // Set config for App.tsx compatibility
        if (!window.analyticsHubConfig) {
          window.analyticsHubConfig = { autoTrack: hasAnalyticsConsent() };
        }
      })();
    </script>
  </head>

  <body>
    <div id="root"></div>

    <!-- Main application script with nonce -->
    <script type="module" src="/assets/index-{{HASH}}.js" nonce="{{NONCE}}"></script>
  </body>
</html>
