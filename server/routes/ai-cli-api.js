const express = require('express');
const router = express.Router();
const { PrismaClient } = require('@prisma/client');
const { getAuthCtx } = require('../middleware/rbac');
const { audit } = require('../middleware/audit');
const { requireCsrf } = require('../middleware/security');
const prisma = new PrismaClient();

// ===== AI CLI SYSTEM =====
// This transforms your CLI from just a style into an intelligent AI assistant

// AI CLI command execution
router.post('/exec', requireCsrf, async (req, res) => {
    try {
        const { command, args = {}, context = {} } = req.body;
        
        // Get authentication context
        const ctx = await getAuthCtx(req);
        
        // AI-powered command processing
        const response = await processAICommand(command, args, ctx, context);
        
        // Audit the interaction
        await audit(ctx, `ai-cli:${command}`, args, true, 'AI CLI command executed');
        
        res.json({
            ok: true,
            response: response.output,
            suggestions: response.suggestions,
            actions: response.actions,
            context: response.context
        });
        
    } catch (error) {
        console.error('AI CLI error:', error);
        res.status(500).json({
            ok: false,
            error: 'AI CLI command failed',
            message: error.message
        });
    }
});

// AI-powered command processing
async function processAICommand(command, args, ctx, context) {
    const cmd = command.toLowerCase().trim();
    
    // AI Context Analysis
    const userContext = await analyzeUserContext(ctx.userId);
    const systemContext = await getSystemContext();
    
    // Command Intent Recognition
    const intent = recognizeIntent(cmd, args);
    
    // Generate AI Response
    const response = await generateAIResponse(intent, userContext, systemContext, ctx);
    
    return response;
}

// Analyze user context for personalized responses
async function analyzeUserContext(userId) {
    try {
        const user = await prisma.user.findFirst({
            where: { id: userId },
            include: {
                profile: true,
                account: true
            }
        });
        
        if (!user) return { level: 'new', experience: 'beginner' };
        
        // Analyze user experience level
        const experience = await analyzeExperienceLevel(userId);
        const preferences = await analyzeUserPreferences(userId);
        
        return {
            level: experience.level,
            experience: experience.category,
            preferences: preferences,
            profile: user.profile,
            joinDate: user.createdAt
        };
    } catch (error) {
        console.error('User context analysis failed:', error);
        return { level: 'unknown', experience: 'beginner' };
    }
}

// Analyze user experience level
async function analyzeExperienceLevel(userId) {
    try {
        // Count user activities
        const stats = await prisma.$queryRaw`
            SELECT 
                (SELECT COUNT(*) FROM "Contribution" WHERE "userId" = ${userId}) as contributions,
                (SELECT COUNT(*) FROM "UserBadge" WHERE "userId" = ${userId}) as badges,
                (SELECT COUNT(*) FROM "UserRole" WHERE "userId" = ${userId}) as roles
        `;
        
        const contributionCount = Number(stats[0]?.contributions || 0);
        const badgeCount = Number(stats[0]?.badges || 0);
        const roleCount = Number(stats[0]?.roles || 0);
        
        // Determine experience level
        let level = 'beginner';
        let category = 'new_user';
        
        if (contributionCount > 50 && badgeCount > 5) {
            level = 'expert';
            category = 'power_user';
        } else if (contributionCount > 20 && badgeCount > 2) {
            level = 'intermediate';
            category = 'active_user';
        } else if (contributionCount > 5) {
            level = 'beginner';
            category = 'growing_user';
        }
        
        return { level, category, stats: { contributions: contributionCount, badges: badgeCount, roles: roleCount } };
    } catch (error) {
        return { level: 'beginner', category: 'new_user' };
    }
}

// Analyze user preferences
async function analyzeUserPreferences(userId) {
    try {
        const profile = await prisma.userProfile.findFirst({
            where: { userId }
        });
        
        return {
            theme: profile?.theme || 'default',
            notifications: profile?.notifications || 'all',
            privacy: profile?.privacy || 'public'
        };
    } catch (error) {
        return { theme: 'default', notifications: 'all', privacy: 'public' };
    }
}

// Get system context
async function getSystemContext() {
    try {
        const stats = await prisma.$queryRaw`
            SELECT 
                (SELECT COUNT(*) FROM "User") as total_users,
                (SELECT COUNT(*) FROM "Company") as total_companies,
                (SELECT COUNT(*) FROM "Team") as total_teams,
                (SELECT COUNT(*) FROM "Project") as total_projects
        `;
        
        return {
            platform: {
                users: Number(stats[0]?.total_users || 0),
                companies: Number(stats[0]?.total_companies || 0),
                teams: Number(stats[0]?.total_teams || 0),
                projects: Number(stats[0]?.total_projects || 0)
            },
            status: 'operational',
            version: '2.0.0'
        };
    } catch (error) {
        return { platform: { users: 0, companies: 0, teams: 0, projects: 0 }, status: 'unknown', version: '2.0.0' };
    }
}

// Recognize command intent
function recognizeIntent(command, args) {
    const cmd = command.toLowerCase();
    
    // Intent patterns
    const intents = {
        // System commands
        'help': { type: 'help', category: 'system' },
        'status': { type: 'status', category: 'system' },
        'version': { type: 'version', category: 'system' },
        
        // Company management
        'company': { type: 'company_management', category: 'business' },
        'companies': { type: 'company_listing', category: 'business' },
        'create company': { type: 'company_creation', category: 'business' },
        
        // Team management
        'team': { type: 'team_management', category: 'collaboration' },
        'teams': { type: 'team_listing', category: 'collaboration' },
        'create team': { type: 'team_creation', category: 'collaboration' },
        
        // Project management
        'project': { type: 'project_management', category: 'workflow' },
        'projects': { type: 'project_listing', category: 'workflow' },
        'create project': { type: 'project_creation', category: 'workflow' },
        
        // User management
        'user': { type: 'user_management', category: 'administration' },
        'users': { type: 'user_listing', category: 'administration' },
        'profile': { type: 'profile_management', category: 'personal' },
        
        // Gamification
        'xp': { type: 'experience', category: 'gamification' },
        'badge': { type: 'badge_management', category: 'gamification' },
        'level': { type: 'level_info', category: 'gamification' },
        
        // Analytics
        'stats': { type: 'statistics', category: 'analytics' },
        'analytics': { type: 'analytics', category: 'analytics' },
        'report': { type: 'reporting', category: 'analytics' }
    };
    
    // Find matching intent
    for (const [pattern, intent] of Object.entries(intents)) {
        if (cmd.includes(pattern)) {
            return { ...intent, confidence: 0.9, original: command };
        }
    }
    
    // Default intent
    return { type: 'unknown', category: 'general', confidence: 0.1, original: command };
}

// Generate AI response
async function generateAIResponse(intent, userContext, systemContext, ctx) {
    const responses = {
        help: generateHelpResponse(userContext),
        status: generateStatusResponse(systemContext),
        company_management: generateCompanyManagementResponse(userContext),
        team_management: generateTeamManagementResponse(userContext),
        project_management: generateProjectManagementResponse(userContext),
        user_management: generateUserManagementResponse(userContext),
        gamification: generateGamificationResponse(userContext),
        analytics: generateAnalyticsResponse(userContext),
        unknown: generateUnknownCommandResponse(intent.original, userContext)
    };
    
    const response = responses[intent.type] || responses.unknown;
    
    // Add contextual suggestions
    response.suggestions = generateContextualSuggestions(intent, userContext, systemContext);
    
    // Add actionable items
    response.actions = generateActionableItems(intent, userContext);
    
    return response;
}

// Generate help response
function generateHelpResponse(userContext) {
    const level = userContext.level;
    
    const helpContent = {
        beginner: {
            output: `üéØ Welcome to SmartStart! I'm your AI assistant, ready to help you navigate the platform.

üìö **Getting Started Commands:**
‚Ä¢ help - Show this help message
‚Ä¢ status - Check system status
‚Ä¢ profile - View your profile
‚Ä¢ companies - List companies
‚Ä¢ teams - List teams

üí° **Quick Actions:**
‚Ä¢ Create your first company
‚Ä¢ Join or create a team
‚Ä¢ Start your first project

üîç **Need Help?** Type any command and I'll guide you through it!`,
            suggestions: ['companies', 'teams', 'profile', 'status']
        },
        intermediate: {
            output: `üöÄ Welcome back! I see you're getting comfortable with SmartStart.

üìä **Management Commands:**
‚Ä¢ companies - Manage your companies
‚Ä¢ teams - Handle team operations
‚Ä¢ projects - Project management
‚Ä¢ users - User administration
‚Ä¢ analytics - View insights

‚ö° **Pro Tips:**
‚Ä¢ Use filters for better search results
‚Ä¢ Set up automated workflows
‚Ä¢ Monitor team performance

üéØ **What would you like to work on today?**`,
            suggestions: ['projects', 'analytics', 'users', 'workflows']
        },
        expert: {
            output: `üèÜ Welcome back, Power User! You're making the most of SmartStart.

üöÄ **Advanced Commands:**
‚Ä¢ analytics - Deep insights
‚Ä¢ reports - Custom reporting
‚Ä¢ integrations - API management
‚Ä¢ automation - Workflow setup
‚Ä¢ performance - Optimization

üíº **Pro Features:**
‚Ä¢ Advanced analytics
‚Ä¢ Custom workflows
‚Ä¢ API integrations
‚Ä¢ Performance monitoring

üéØ **Ready to optimize something?**`,
            suggestions: ['analytics', 'automation', 'integrations', 'performance']
        }
    };
    
    return helpContent[level] || helpContent.beginner;
}

// Generate status response
function generateStatusResponse(systemContext) {
    const { platform } = systemContext;
    
    return {
        output: `üìä **SmartStart Platform Status**

‚úÖ **System Status:** OPERATIONAL
üîÑ **Version:** ${systemContext.version}
‚è∞ **Uptime:** All systems running

üë• **Platform Metrics:**
‚Ä¢ Users: ${platform.users.toLocaleString()}
‚Ä¢ Companies: ${platform.companies.toLocaleString()}
‚Ä¢ Teams: ${platform.teams.toLocaleString()}
‚Ä¢ Projects: ${platform.projects.toLocaleString()}

üéØ **All 7 Systems:** DEPLOYED & OPERATIONAL
üîí **Security:** Active & Monitored
üìà **Performance:** Optimal

Everything is running smoothly! What would you like to work on?`,
        suggestions: ['companies', 'teams', 'projects', 'analytics']
    };
}

// Generate company management response
function generateCompanyManagementResponse(userContext) {
    return {
        output: `üè¢ **Company Management System**

I can help you with all aspects of company management:

üìã **Available Actions:**
‚Ä¢ List all companies
‚Ä¢ Create new company
‚Ä¢ View company details
‚Ä¢ Update company info
‚Ä¢ Manage company settings

üí° **Quick Commands:**
‚Ä¢ companies - List all companies
‚Ä¢ create company - Start new company
‚Ä¢ company [id] - View specific company

üéØ **What would you like to do with companies?**`,
        suggestions: ['companies', 'create company', 'company details']
    };
}

// Generate team management response
function generateTeamManagementResponse(userContext) {
    return {
        output: `üë• **Team Management System**

Let's build amazing teams together:

üìã **Available Actions:**
‚Ä¢ List all teams
‚Ä¢ Create new team
‚Ä¢ Manage team members
‚Ä¢ Set team goals
‚Ä¢ Track performance

üí° **Quick Commands:**
‚Ä¢ teams - List all teams
‚Ä¢ create team - Build new team
‚Ä¢ team [id] - View team details

üéØ **Ready to build your dream team?**`,
        suggestions: ['teams', 'create team', 'team goals']
    };
}

// Generate project management response
function generateProjectManagementResponse(userContext) {
    return {
        output: `üìã **Project Management System**

Turn ideas into reality with our project tools:

üìã **Available Actions:**
‚Ä¢ List all projects
‚Ä¢ Create new project
‚Ä¢ Assign tasks
‚Ä¢ Track progress
‚Ä¢ Generate reports

üí° **Quick Commands:**
‚Ä¢ projects - List all projects
‚Ä¢ create project - Start new project
‚Ä¢ project [id] - View project details

üéØ **What project would you like to work on?**`,
        suggestions: ['projects', 'create project', 'project tasks']
    };
}

// Generate user management response
function generateUserManagementResponse(userContext) {
    return {
        output: `üë§ **User Management System**

Manage your team and users effectively:

üìã **Available Actions:**
‚Ä¢ List all users
‚Ä¢ View user profiles
‚Ä¢ Manage permissions
‚Ä¢ Track activity
‚Ä¢ Generate reports

üí° **Quick Commands:**
‚Ä¢ users - List all users
‚Ä¢ user [id] - View user details
‚Ä¢ profile - Your profile

üéØ **Need to manage users or update your profile?**`,
        suggestions: ['users', 'profile', 'permissions']
    };
}

// Generate gamification response
function generateGamificationResponse(userContext) {
    return {
        output: `üéÆ **Gamification System**

Level up and earn rewards:

üìä **Your Progress:**
‚Ä¢ Level: ${userContext.profile?.level || 'Unknown'}
‚Ä¢ Experience: Growing daily
‚Ä¢ Badges: Earn more!

üèÜ **Available Actions:**
‚Ä¢ Check your level
‚Ä¢ View badges
‚Ä¢ Track progress
‚Ä¢ See leaderboard

üí° **Quick Commands:**
‚Ä¢ level - Your current level
‚Ä¢ badges - Your achievements
‚Ä¢ xp - Experience points

üéØ **Ready to level up?**`,
        suggestions: ['level', 'badges', 'xp', 'leaderboard']
    };
}

// Generate analytics response
function generateAnalyticsResponse(userContext) {
    return {
        output: `üìà **Analytics & Reporting System**

Get insights into your performance:

üìä **Available Reports:**
‚Ä¢ User activity
‚Ä¢ Team performance
‚Ä¢ Project metrics
‚Ä¢ Company growth
‚Ä¢ Custom reports

üí° **Quick Commands:**
‚Ä¢ analytics - Overview
‚Ä¢ stats - Quick stats
‚Ä¢ report [type] - Generate report

üéØ **What insights are you looking for?**`,
        suggestions: ['analytics', 'stats', 'reports']
    };
}

// Generate unknown command response
function generateUnknownCommandResponse(command, userContext) {
    return {
        output: `ü§î **Command Not Recognized**

I didn't understand: "${command}"

üí° **Try these instead:**
‚Ä¢ help - Show all commands
‚Ä¢ status - System status
‚Ä¢ companies - Company management
‚Ä¢ teams - Team management
‚Ä¢ projects - Project management

üîç **Or ask me to help you with something specific:**
‚Ä¢ "How do I create a company?"
‚Ä¢ "Show me my teams"
‚Ä¢ "What projects do I have?"

üéØ **I'm here to help! What would you like to do?**`,
        suggestions: ['help', 'status', 'companies', 'teams']
    };
}

// Generate contextual suggestions
function generateContextualSuggestions(intent, userContext, systemContext) {
    const suggestions = {
        beginner: ['help', 'profile', 'companies', 'teams'],
        intermediate: ['projects', 'analytics', 'users', 'workflows'],
        expert: ['analytics', 'automation', 'integrations', 'performance']
    };
    
    return suggestions[userContext.level] || suggestions.beginner;
}

// Generate actionable items
function generateActionableItems(intent, userContext) {
    const actions = {
        company_management: [
            { type: 'create', label: 'Create Company', command: 'create company' },
            { type: 'list', label: 'List Companies', command: 'companies' },
            { type: 'manage', label: 'Manage Companies', command: 'company manage' }
        ],
        team_management: [
            { type: 'create', label: 'Create Team', command: 'create team' },
            { type: 'list', label: 'List Teams', command: 'teams' },
            { type: 'manage', label: 'Manage Teams', command: 'team manage' }
        ],
        project_management: [
            { type: 'create', label: 'Create Project', command: 'create project' },
            { type: 'list', label: 'List Projects', command: 'projects' },
            { type: 'manage', label: 'Manage Projects', command: 'project manage' }
        ]
    };
    
    return actions[intent.type] || [];
}

// Get AI CLI status
router.get('/status', async (req, res) => {
    try {
        res.json({
            ok: true,
            system: 'SmartStart AI CLI',
            version: '2.0.0',
            status: 'OPERATIONAL',
            features: [
                'Intent Recognition',
                'Contextual Responses',
                'Personalized Suggestions',
                'Actionable Items',
                'Smart Command Processing'
            ],
            capabilities: [
                'Natural Language Understanding',
                'Context-Aware Responses',
                'Personalized Guidance',
                'Proactive Suggestions',
                'Intelligent Workflows'
            ]
        });
    } catch (error) {
        res.status(500).json({
            ok: false,
            error: 'Failed to get AI CLI status'
        });
    }
});

module.exports = router;
